#  基于 `VirtualBox` 的网络攻防基础环境搭建

## 实验目的

- 掌握 `VirtualBox` 虚拟机的安装与使用；
- 掌握 `VirtualBox` 的虚拟网络类型和按需配置；
- 掌握 `VirtualBox` 的虚拟硬盘多重加载；

## 实验环境

以下是本次实验需要使用的网络节点说明和主要软件举例：

- `VirtualBox` 虚拟机
- 攻击者主机（`Attacker`）：`Kali` 
- 网关（`Gateway`, `GW`）：`Debian 10`
- 靶机（`Victim`）：`From Sqli to shell / xp-sp3 / Kali`

## 实验要求

- 虚拟硬盘配置成多重加载；

- 搭建如下拓扑图所示的虚拟机网络拓扑；

> 根据实验宿主机的性能条件，可以适度精简靶机数量

- 完成以下网络连通性测试。
  - [x] 靶机可以直接访问攻击者主机
  - [x] 攻击者主机无法直接访问靶机
  - [x]  网关可以直接访问攻击者主机和靶机
  - [x] 靶机的所有对外上下行流量必须经过网关
  - [x] 所有节点均可以访问互联网

## 实验流程

### 1.配置虚拟硬盘的多重加载

点击`管理`，选择`虚拟硬盘管理`，选中`属性`，于类型切换为`多重加载`。

![multipleload](/./img/multipleload.jpg)

### 2.搭建虚拟机网络拓扑图

![outline](/./img/outline.jpg)

#### 网关：

四块网卡配置：

网卡1：`NAT网络`（可使网关访问攻击者主机）

网卡2：`hostonly`(主机网络)

网卡3：`intnet1`(局域网1)

网卡4：`intnet2`(局域网2)

![network-setting](\.\img\network-setting.jpg)

联通情况展示：

![gw-setting](\.\img\gw-setting.jpg)

#### attacker:

`NAT网络`和`hostonly`

![attacker-setting](\.\img\attacker-setting.jpg)

#### victim:

`xp-09005`和`kali`在局域网`network1`

`xp-09005-2`和`debian-gw`在局域网`network2`

![victim-intnet1](\.\img\victim-intnet1.jpg)

![victim-intnet2](\.\img\victim-intnet2.jpg)

3.联通性测试

各虚拟机`IP`地址如下：

| 虚拟机          | `IP`地址       |
| --------------- | -------------- |
| `kali-attacker` | 10.0.2.15      |
| `kali`          | 172.16.111.117 |
| `xp-09005`      | 172.16.111.129 |
| `debain-2`      | 172.16.222.105 |
| `xp-09005-2`    | 172.16.222.142 |

* 靶机可以直接访问攻击者主机

  * `xp-09005`->`kali-attacker`

  ![victim.attacker1](\.\img\victim.attacker1.jpg)

  * `debain-2`->`kali-attacker`

![victim.attacker2](\.\img\victim.attacker2.jpg)

* 攻击者主机无法访问靶机

  * `kali-attacker`->`xp-09005`

  ![attacker.victim1](\.\img\attacker.victim1.jpg)

  * `kali-attacker`->`debain-2`

![attacker.victim2](\.\img\attacker.victim2.jpg)

* 网关可以直接访问攻击者主机和靶机

  * `gw`->`kali-attacker`

  ![gw.kali-attacker](\.\img\gw.kali-attacker.jpg)

  * `gw`->`kali`

  ![gw.kali](\.\img\gw.kali.jpg)

  * `gw`->`xp-09005`

  ![gw.xp-09005](\.\img\gw.xp-09005.jpg)

  * `gw`->`debain-2`

  ![gw.debain-2](\.\img\gw.debain-2.jpg)

  * `gw`->`xp-090005-2`

![gw.xp-09005-2](\.\img\gw.xp-09005-2.jpg)

* 靶机的所有对外上下行流量必须经过网关

  * `xp-09005`上`ping baidu.com`于`debain-gw`上开启抓包器，流量流经网关服务器。

  在网关上以`tcpdump`指令抓包，以下结果可证明靶机的所有对外上下行流量必须经过网关。

![ping.baidu](\.\img\ping.baidu.jpg)

验证`xp`网络层连通性（`ICMP`协议可达）

![xp-network](\.\img\xp-network.jpg)

* 所有节点可以访问互联网

  * `gw`

  ![gw.baidu](\.\img\gw.baidu.jpg)

  * `kali-attacker`

  ![kali-attacker.baidu](\.\img\kali-attacker.baidu.jpg)

  * `kali`

  ![kali.baidu](\.\img\kali.baidu.jpg)

  * `xp-09005-2`

  ![xp-090005-2.baidu](\.\img\xp-090005-2.baidu.jpg)

`debain` `ping` `xp`

在未关闭防火墙的条件下无法成功`ping`通

![closefirewall](\.\img\closefirewall.jpg)

在关闭之后可以成功`ping`通

![debain.ping.xp](\.\img\debain.ping.xp.jpg)

`xp` `ping` `hostonly` 

无法`ping`通

![xp.ping.hostonly](\.\img\xp.ping.hostonly.jpg)

`debain`中输入指令

```
apt update && apt install dnsmasq
```

`kali` `ping` `xp`

![kali.ping.xp](\.\img\kali.ping.xp.jpg)

`xp` `ping` `www.cuc.edu.cn`

![xp.ping.cuc](\.\img\xp.ping.cuc.jpg)

`xp` `ping` `www.zhihu.com` `debain` 可观测过程

![xp.ping.zhihu.debian](\.\img\xp.ping.zhihu.debian.jpg)

二、实验中的问题及解决。

1.debain `ssh`方式登录`root`失败

![ERR1](\.\img\ERR1.jpg)

修改

```
/etc/ssh/sshd_config
```

```
vi /etc/ssh/sshd_config
```

添加一行代码：

```
PermitRootLogin yes
```

![ERR2](\.\img\ERR2.jpg)

重启`ssh`服务

```
/etc/init.d/ssh restart
```

解决后可成功`ssh`

![ERR3](\.\img\ERR3.jpg)

2.`xp`中在命令行输入`ipconfig`显示其不是内部或外部命令，也不是可运行的程序。

![ERR4](\.\img\ERR4.jpg)

输入指令 

```
cd c:\windows\system32
```

再输入`ipconfig`即可显示`ip`信息

![ERR5](\.\img\ERR5.jpg)

三、参考资料。

[配置Debian允许root用户SSH登录](https://blog.csdn.net/allway2/article/details/106961332/)

